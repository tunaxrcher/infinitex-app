// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// ============================================
// USER TYPES (Customer & Agent only)
// ============================================

enum UserType {
  CUSTOMER
  AGENT
}

// User authentication and profile (Customer & Agent)
model User {
  id          String  @id @default(cuid())
  phoneNumber String  @unique @db.VarChar(20)
  pin         String? @db.VarChar(255) // 4-digit PIN (will be replaced by OTP in future)

  // OTP fields for future use
  otpSecret     String?   @db.VarChar(255)
  otpEnabled    Boolean   @default(false)
  lastOtpSentAt DateTime? @db.DateTime(0)

  userType    UserType  @default(CUSTOMER)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime? @db.DateTime(0)

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  // Profile information
  profile UserProfile?

  // Customer relationships
  loanApplications  LoanApplication[]  @relation("CustomerApplications")
  loans             Loan[]             @relation("CustomerLoans")
  payments          Payment[]
  notifications     Notification[]
  coinTransactions  CoinTransaction[]
  rewardRedemptions RewardRedemption[]
  sessions          Session[]

  // Agent relationships
  agentApplications LoanApplication[] @relation("AgentApplications")
  agentCustomers    AgentCustomer[]   @relation("AgentRelationships")
  customerAgents    AgentCustomer[]   @relation("CustomerAgents")
  managedLoans      Loan[]            @relation("AgentManagedLoans")

  @@map("users")
}

// Extended user profile information
model UserProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal information
  fullName     String?   @db.VarChar(500)
  idCardNumber String?   @db.VarChar(13)
  dateOfBirth  DateTime? @db.DateTime(0)
  address      String?   @db.Text

  // Contact information
  email  String? @db.VarChar(255)
  lineId String? @db.VarChar(255)

  // KYC documents
  idCardFrontImage String? @db.VarChar(500)
  idCardBackImage  String? @db.VarChar(500)

  // Preferences
  preferredLanguage   String  @default("th") @db.VarChar(10)
  notificationEnabled Boolean @default(true)

  // Coin system
  coinBalance Int @default(0)

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  @@map("user_profiles")
}

// Agent-Customer relationship management
model AgentCustomer {
  id         String @id @default(cuid())
  agentId    String
  customerId String
  agent      User   @relation("AgentRelationships", fields: [agentId], references: [id], onDelete: Cascade)
  customer   User   @relation("CustomerAgents", fields: [customerId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now()) @db.DateTime(0)
  isActive   Boolean  @default(true)

  @@unique([agentId, customerId])
  @@index([agentId])
  @@index([customerId])
  @@map("agent_customers")
}

// ============================================
// ADMIN SYSTEM (Separate from Users)
// ============================================

enum AdminRole {
  SUPER_ADMIN // ทำได้ทุกอย่าง
  LOAN_OFFICER // จัดการสินเชื่อ
  CUSTOMER_SERVICE // ดูแลลูกค้า
  FINANCE // จัดการการเงิน
  CONTENT_MANAGER // จัดการ Banner/Privilege
}

enum PermissionCode {
  // Loan Application Management
  VIEW_APPLICATIONS
  APPROVE_APPLICATIONS
  REJECT_APPLICATIONS

  // Loan Management
  VIEW_LOANS
  CREATE_LOANS
  UPDATE_LOANS
  DELETE_LOANS

  // User Management
  VIEW_USERS
  CREATE_USERS
  UPDATE_USERS
  DELETE_USERS
  MANAGE_AGENTS

  // Payment Management
  VIEW_PAYMENTS
  PROCESS_PAYMENTS
  REFUND_PAYMENTS

  // Content Management
  MANAGE_BANNERS
  MANAGE_PRIVILEGES
  MANAGE_REWARDS

  // System Configuration
  MANAGE_SYSTEM_CONFIG
  VIEW_AUDIT_LOGS

  // Reports & Analytics
  VIEW_REPORTS
  EXPORT_DATA
}

// Admin users (ระบบหลังบ้าน)
model Admin {
  id       String @id @default(cuid())
  email    String @unique @db.VarChar(255)
  password String @db.VarChar(255) // Hashed password

  // Admin information
  firstName String    @db.VarChar(255)
  lastName  String    @db.VarChar(255)
  role      AdminRole @default(LOAN_OFFICER)

  // Status
  isActive    Boolean   @default(true)
  lastLoginAt DateTime? @db.DateTime(0)

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  // Relationships
  permissions          AdminPermission[]
  sessions             AdminSession[]
  auditLogs            AuditLog[]
  reviewedApplications LoanApplication[]   @relation("AdminReviewed")
  landAccountLogs      LandAccountLog[]
  landAccountReports   LandAccountReport[]

  @@map("admins")
}

// Admin permissions (fine-grained control)
model AdminPermission {
  id         String         @id @default(cuid())
  adminId    String
  admin      Admin          @relation(fields: [adminId], references: [id], onDelete: Cascade)
  permission PermissionCode

  grantedAt DateTime @default(now()) @db.DateTime(0)
  grantedBy String?  @db.VarChar(255) // Admin ID who granted this

  @@unique([adminId, permission])
  @@index([adminId])
  @@map("admin_permissions")
}

// Admin session management (separate from user sessions)
model AdminSession {
  id      String @id @default(cuid())
  adminId String
  admin   Admin  @relation(fields: [adminId], references: [id], onDelete: Cascade)

  token      String  @unique @db.VarChar(500)
  deviceInfo String? @db.VarChar(500)
  ipAddress  String? @db.VarChar(45)
  userAgent  String? @db.Text

  expiresAt DateTime @db.DateTime(0)
  createdAt DateTime @default(now()) @db.DateTime(0)

  @@index([adminId])
  @@index([token])
  @@map("admin_sessions")
}

// ============================================
// LOAN SYSTEM
// ============================================

enum LoanType {
  HOUSE_LAND_MORTGAGE // สินเชื่อจำนองบ้านและโฉนดที่ดิน
  CAR_REGISTRATION // สินเชื่อทะเบียนรถ (future)
  FINX_PLUS // สินเชื่อ FinX พลัส (future)
}

enum DeedMode {
  SINGLE // โฉนดเดี่ยว (1 ใบ)
  MULTIPLE // โฉนดชุด (หลายใบ)
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

// Loan application workflow
model LoanApplication {
  id String @id @default(cuid())

  // Relationships (nullable to match schema 2)
  customerId String?
  customer   User?   @relation("CustomerApplications", fields: [customerId], references: [id], onDelete: Cascade)
  agentId    String? // Optional: if submitted by agent
  agent      User?   @relation("AgentApplications", fields: [agentId], references: [id])

  // Application details
  loanType     LoanType          @default(HOUSE_LAND_MORTGAGE)
  hirePurchase Boolean           @default(false)
  status       ApplicationStatus @default(DRAFT)
  deedMode     DeedMode          @default(SINGLE) // โฉนดเดี่ยว หรือ โฉนดชุด

  // Multi-step form tracking
  currentStep      Int     @default(1)
  completedSteps   Json    @default("[]") // Array of completed step numbers
  isNewUser        Boolean @default(false)
  submittedByAgent Boolean @default(false)

  // Title deeds relation (all deed info stored here - both single and multiple mode)
  titleDeeds TitleDeed[]

  // Total property value (sum of all title deeds)
  totalPropertyValue Decimal? @db.Decimal(15, 2)

  // Supporting documents
  supportingImages Json @default("[]") // Array of image URLs

  // ID Card (for new users)
  idCardFrontImage String? @db.VarChar(500)
  idCardBackImage  String? @db.VarChar(500)

  // Loan amount
  requestedAmount   Decimal  @default(0) @db.Decimal(15, 2)
  approvedAmount    Decimal? @db.Decimal(15, 2)
  maxApprovedAmount Decimal? @db.Decimal(15, 2) // System calculated maximum

  // Loan terms (from admin input)
  interestRate Decimal? @db.Decimal(5, 2) // ดอกเบี้ยต่อปี (%)
  termMonths   Int?     @default(48) // จำนวนเดือน default 48 เดือน (4 ปี)

  // Fees
  operationFee Decimal? @default(0) @db.Decimal(15, 2)
  transferFee  Decimal? @default(0) @db.Decimal(15, 2)
  otherFee     Decimal? @default(0) @db.Decimal(15, 2)

  // Owner name (user input - may differ from deed owner)
  ownerName String? @db.VarChar(255)

  // Property valuation (AI assessment on submit)
  propertyValue   Decimal?  @db.Decimal(15, 2) // มูลค่าประเมินรวม
  valuationResult Json?                        // ผลการประเมินจาก AI
  valuationDate   DateTime? @db.DateTime(0)    // วันที่ทำการประเมิน
  estimatedValue  Decimal?  @db.Decimal(15, 2) // มูลค่าประเมินที่บันทึก

  // Application metadata
  submittedAt     DateTime? @db.DateTime(0)
  reviewedAt      DateTime? @db.DateTime(0)
  reviewedBy      String? // Admin ID
  reviewedByAdmin Admin?    @relation("AdminReviewed", fields: [reviewedBy], references: [id])
  reviewNotes     String?   @db.Text

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  // If approved, creates a loan
  loan Loan?

  @@index([customerId])
  @@index([agentId])
  @@index([status])
  @@index([reviewedBy])
  @@map("loan_applications")
}

// Title deed for multiple deeds support
model TitleDeed {
  id            String          @id @default(cuid())
  applicationId String
  application   LoanApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Image information (optional - old data may not have image)
  imageUrl String? @db.VarChar(500)
  imageKey String? @db.VarChar(500)

  // Title deed information (from AI or manual input)
  deedNumber   String? @db.VarChar(100) // เลขที่โฉนด/ระวาง
  provinceName String? @db.VarChar(100)
  amphurName   String? @db.VarChar(100)
  parcelNo     String? @db.VarChar(100) // เลขที่โฉนด

  // Land information
  landAreaText String?  @db.VarChar(100) // เช่น "2 ไร่ 1 งาน 50 ตร.ว."
  ownerName    String?  @db.VarChar(255)
  landType     String?  @db.VarChar(100) // ประเภทที่ดิน

  // Raw data from LandMaps API
  titleDeedData Json? // ข้อมูลดิบจาก LandMap API

  // Location data (from LandMaps API)
  latitude  String? @db.VarChar(50)
  longitude String? @db.VarChar(50)
  linkMap   String? @db.Text

  // Meta
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false) // โฉนดหลักในกรณีหลายโฉนด

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  @@index([applicationId])
  @@map("title_deeds")
}

enum LoanStatus {
  ACTIVE
  COMPLETED
  DEFAULTED
  CANCELLED
}

// Active loans
model Loan {
  id         String @id @default(cuid())
  loanNumber String @unique @db.VarChar(50)

  // Relationships (nullable to match schema 2)
  customerId    String?
  customer      User?           @relation("CustomerLoans", fields: [customerId], references: [id], onDelete: Cascade)
  agentId       String?
  agent         User?           @relation("AgentManagedLoans", fields: [agentId], references: [id])
  applicationId String          @unique
  application   LoanApplication @relation(fields: [applicationId], references: [id])

  // Loan details
  loanType        LoanType
  hirePurchase    Boolean    @default(false)
  status          LoanStatus @default(ACTIVE)
  principalAmount Decimal    @db.Decimal(15, 2)
  interestRate    Decimal    @db.Decimal(5, 2) // Annual interest rate
  termMonths      Int // Loan term in months
  monthlyPayment  Decimal    @db.Decimal(15, 2)

  // Payment tracking
  currentInstallment Int      @default(0)
  totalInstallments  Int
  remainingBalance   Decimal  @db.Decimal(15, 2)
  nextPaymentDate    DateTime @db.DateTime(0)

  // Contract information
  contractDate    DateTime @db.DateTime(0)
  expiryDate      DateTime @db.DateTime(0)
  titleDeedNumber String?  @db.VarChar(100)

  // Collateral information
  collateralValue   Decimal? @db.Decimal(15, 2)
  collateralDetails Json?

  // Land account integration
  linkMap         String? @db.Text
  landAccountId   Int?
  landAccountName String? @db.VarChar(200)

  // Property location (from LandMaps API)
  latitude  String? @db.VarChar(50) // parcellat
  longitude String? @db.VarChar(50) // parcellon

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  // Related records
  payments     Payment[]
  installments LoanInstallment[]

  @@index([customerId])
  @@index([agentId])
  @@index([status])
  @@index([loanNumber])
  @@map("loans")
}

// Loan installment schedule
model LoanInstallment {
  id     String @id @default(cuid())
  loanId String
  loan   Loan   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  installmentNumber Int
  dueDate           DateTime @db.DateTime(0)
  principalAmount   Decimal  @db.Decimal(15, 2)
  interestAmount    Decimal  @db.Decimal(15, 2)
  totalAmount       Decimal  @db.Decimal(15, 2)

  isPaid     Boolean   @default(false)
  paidDate   DateTime? @db.DateTime(0)
  paidAmount Decimal?  @db.Decimal(15, 2)

  // Late payment tracking
  isLate   Boolean  @default(false)
  lateDays Int?
  lateFee  Decimal? @db.Decimal(15, 2)

  // Payment proof & additional information
  paymentProofUrl        String?   @db.VarChar(500)
  paymentProofUploadedAt DateTime? @db.DateTime(0)
  refNo                  String?   @db.VarChar(100)
  filePayload            Json?
  note                   String?   @db.Text

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  // Relation to payments
  payments Payment[]

  @@unique([loanId, installmentNumber])
  @@index([loanId])
  @@index([dueDate])
  @@map("loan_installments")
}

// ============================================
// PAYMENT SYSTEM
// ============================================

enum PaymentMethod {
  CASH
  QR_CODE
  BARCODE
  INTERNET_BANKING
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// Payment records
model Payment {
  id String @id @default(cuid())

  // Relationships (nullable to match schema 2)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  loanId String?
  loan   Loan?   @relation(fields: [loanId], references: [id], onDelete: Cascade)

  // Link to installment
  installmentId String?
  installment   LoanInstallment? @relation(fields: [installmentId], references: [id])

  // Payment details
  amount        Decimal       @db.Decimal(15, 2)
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)

  // Payment reference
  referenceNumber String  @unique @db.VarChar(100)
  transactionId   String? @db.VarChar(100) // External transaction ID

  // QR/Barcode specific
  qrCode        String? @db.Text
  barcodeNumber String? @db.VarChar(50)

  // Bank details
  bankName      String? @db.VarChar(100)
  accountNumber String? @db.VarChar(50)
  accountName   String? @db.VarChar(255)

  // Timing
  dueDate  DateTime  @db.DateTime(0)
  paidDate DateTime? @db.DateTime(0)

  // Breakdown
  principalAmount Decimal @default(0) @db.Decimal(15, 2)
  interestAmount  Decimal @default(0) @db.Decimal(15, 2)
  feeAmount       Decimal @default(0) @db.Decimal(15, 2)

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  @@index([userId])
  @@index([loanId])
  @@index([installmentId])
  @@index([status])
  @@index([referenceNumber])
  @@map("payments")
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

enum NotificationType {
  PAYMENT_DUE
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  LOAN_APPROVED
  LOAN_REJECTED
  SYSTEM_ANNOUNCEMENT
  PROMOTION
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String           @db.VarChar(255)
  message   String           @db.Text
  actionUrl String?          @db.VarChar(500)

  isRead Boolean   @default(false)
  readAt DateTime? @db.DateTime(0)

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// ============================================
// GAMIFICATION (COIN SYSTEM)
// ============================================

enum CoinTransactionType {
  EARNED_SIGNUP // สมัครสมาชิก
  EARNED_ON_TIME_PAYMENT // ชำระตรงเวลา
  EARNED_DAILY_TASK // ภาระรายวัน
  EARNED_PROMOTION // โปรโมชั่น
  REDEEMED_REWARD // แลกของรางวัล
  EXPIRED // หมดอายุ
}

model CoinTransaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        CoinTransactionType
  amount      Int // Positive for earning, negative for spending
  description String              @db.VarChar(500)

  // Related records
  loanId   String? // If related to loan payment
  rewardId String? // If related to reward redemption

  createdAt DateTime @default(now()) @db.DateTime(0)

  @@index([userId])
  @@index([type])
  @@map("coin_transactions")
}

// Reward catalog for coin redemption
model Reward {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(255)
  description String  @db.Text
  coinCost    Int
  imageUrl    String? @db.VarChar(500)

  isActive   Boolean @default(true)
  stockCount Int? // null = unlimited

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  // Track redemptions
  redemptions RewardRedemption[]

  @@index([isActive])
  @@map("rewards")
}

enum RedemptionStatus {
  PENDING
  PROCESSING
  DELIVERED
  CANCELLED
}

model RewardRedemption {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  rewardId String
  reward   Reward @relation(fields: [rewardId], references: [id])

  coinSpent Int
  status    RedemptionStatus @default(PENDING)

  // Delivery information
  deliveryAddress String? @db.Text
  trackingNumber  String? @db.VarChar(100)

  redeemedAt  DateTime  @default(now()) @db.DateTime(0)
  deliveredAt DateTime? @db.DateTime(0)

  @@index([userId])
  @@index([rewardId])
  @@index([status])
  @@map("reward_redemptions")
}

// ============================================
// CONTENT MANAGEMENT
// ============================================

// System banners for homepage
model Banner {
  id          String  @id @default(cuid())
  title       String  @db.VarChar(255)
  description String? @db.Text
  imageUrl    String  @db.VarChar(500)
  actionUrl   String? @db.VarChar(500)

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // User targeting - JSON array: ["CUSTOMER", "AGENT"]
  targetUserTypes Json @default("[\"CUSTOMER\", \"AGENT\"]")

  startDate DateTime? @db.DateTime(0)
  endDate   DateTime? @db.DateTime(0)

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  @@index([isActive])
  @@index([sortOrder])
  @@map("banners")
}

// Special privileges/offers
model Privilege {
  id          String  @id @default(cuid())
  title       String  @db.VarChar(255)
  description String  @db.Text
  imageUrl    String? @db.VarChar(500)
  actionUrl   String? @db.VarChar(500)

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  // Enhanced fields - JSON array: ["CUSTOMER"]
  targetUserTypes Json    @default("[\"CUSTOMER\"]")
  coinCost        Int?
  requiresLoan    Boolean @default(false)

  validFrom  DateTime? @db.DateTime(0)
  validUntil DateTime? @db.DateTime(0)

  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  @@index([isActive])
  @@index([sortOrder])
  @@map("privileges")
}

// ============================================
// DOCUMENT MANAGEMENT SYSTEM
// ============================================

enum DocType {
  RECEIPT // ใบเสร็จรับเงิน
  PAYMENT_VOUCHER // ใบสำคัญจ่าย
  DISCOUNT_NOTE // ใบลดหนี้
  EXPENSE // ค่าใช้จ่าย
}

// Document records (receipts, payment vouchers, etc.)
model Document {
  id           String   @id @default(cuid())
  docType      DocType
  docNumber    String   @db.VarChar(100)
  docDate      DateTime @db.DateTime(0)
  title        String   @db.Text
  price        Decimal  @db.Decimal(20, 2)
  cashFlowName String   @db.VarChar(200)

  // Employee/Admin reference
  employeeId Int     @default(0)
  username   String? @db.VarChar(50)

  // File information
  docFile      String?   @db.Text
  docFileDate  DateTime? @db.DateTime(0)
  docFileTime  String?   @db.VarChar(10)
  docFilePrice Decimal?  @db.Decimal(20, 2)
  filePath     String?   @db.Text

  note String? @db.Text

  createdAt DateTime  @default(now()) @db.DateTime(0)
  updatedAt DateTime  @updatedAt @db.DateTime(0)
  deletedAt DateTime? @db.DateTime(0) // Soft delete 

  @@index([docType])
  @@index([docNumber])
  @@index([employeeId])
  @@map("documents")
}

// Document title templates
model DocumentTitleList {
  id      String  @id @default(cuid())
  docType DocType
  title   String  @db.Text
  note    String? @db.Text

  createdAt DateTime  @default(now()) @db.DateTime(0)
  updatedAt DateTime  @updatedAt @db.DateTime(0)
  deletedAt DateTime? @db.DateTime(0) // Soft delete 

  @@index([docType])
  @@map("document_title_lists")
}

// ============================================
// LAND ACCOUNT SYSTEM
// ============================================

// Land accounts for managing land-related finances
model LandAccount {
  id             String  @id @default(cuid())
  accountName    String  @db.VarChar(200)
  accountBalance Decimal @default(0) @db.Decimal(15, 2)

  createdAt DateTime  @default(now()) @db.DateTime(0)
  updatedAt DateTime  @updatedAt @db.DateTime(0)
  deletedAt DateTime? @db.DateTime(0) // Soft delete 

  // Related records
  logs    LandAccountLog[]
  reports LandAccountReport[]

  @@index([accountName])
  @@map("land_accounts")
}

// Land account transaction logs
model LandAccountLog {
  id            String      @id @default(cuid())
  landAccountId String
  landAccount   LandAccount @relation(fields: [landAccountId], references: [id], onDelete: Cascade)

  detail String  @db.VarChar(200)
  amount Decimal @default(0) @db.Decimal(15, 2)
  note   String? @db.VarChar(200)

  // Admin reference
  adminId   String?
  admin     Admin?  @relation(fields: [adminId], references: [id])
  adminName String? @db.VarChar(200)

  createdAt DateTime  @default(now()) @db.DateTime(0)
  updatedAt DateTime  @updatedAt @db.DateTime(0)
  deletedAt DateTime? @db.DateTime(0) // Soft delete 

  @@index([landAccountId])
  @@index([adminId])
  @@index([createdAt])
  @@map("land_account_logs")
}

// Land account reports
model LandAccountReport {
  id            String      @id @default(cuid())
  landAccountId String
  landAccount   LandAccount @relation(fields: [landAccountId], references: [id], onDelete: Cascade)

  detail         String   @db.VarChar(200)
  amount         Decimal  @default(0) @db.Decimal(15, 2)
  note           String?  @db.VarChar(200)
  accountBalance Decimal? @default(0) @db.Decimal(15, 2)

  // Admin reference
  adminId   String?
  admin     Admin?  @relation(fields: [adminId], references: [id])
  adminName String? @db.VarChar(200)

  createdAt DateTime  @default(now()) @db.DateTime(0)
  updatedAt DateTime  @updatedAt @db.DateTime(0)
  deletedAt DateTime? @db.DateTime(0) // Soft delete 

  @@index([landAccountId])
  @@index([adminId])
  @@index([createdAt])
  @@map("land_account_reports")
}

// ============================================
// SYSTEM CONFIGURATION & AUDIT
// ============================================

// System configuration
model SystemConfig {
  id    String @id @default(cuid())
  key   String @unique @db.VarChar(255)
  value String @db.Text

  description String?  @db.Text
  updatedAt   DateTime @updatedAt @db.DateTime(0)

  @@index([key])
  @@map("system_config")
}

// User session management (Customer & Agent)
model Session {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token      String  @unique @db.VarChar(500)
  deviceInfo String? @db.VarChar(500)
  ipAddress  String? @db.VarChar(45)
  userAgent  String? @db.Text

  expiresAt DateTime @db.DateTime(0)
  createdAt DateTime @default(now()) @db.DateTime(0)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// Audit log for important actions
model AuditLog {
  id String @id @default(cuid())

  // Who performed the action (can be admin or system)
  adminId String? @db.VarChar(255)
  admin   Admin?  @relation(fields: [adminId], references: [id])

  action    String  @db.VarChar(100)
  entity    String  @db.VarChar(100) // table name
  entityId  String  @db.VarChar(255) // record ID
  oldData   Json?
  newData   Json?
  ipAddress String? @db.VarChar(45)
  userAgent String? @db.Text

  createdAt DateTime @default(now()) @db.DateTime(0)

  @@index([adminId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

model RealInvestment {
  id         String  @id @default(cuid())
  investment Decimal @db.Decimal(20, 2)

  createdAt DateTime  @default(now()) @db.DateTime(0)
  updatedAt DateTime  @updatedAt @db.DateTime(0)
  deletedAt DateTime? @db.DateTime(0) // Soft delete 

  @@map("real_investment")
}

// ============================================
// ASSET SCRAPER SYSTEM (จาก otherdb)
// ============================================

/// แหล่งข้อมูลทรัพย์สิน
enum DataSource {
  LED   // กรมบังคับคดี (Legal Execution Department)
  BAAC  // ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร
  NHA   // การเคหะแห่งชาติ
  GSB   // ธนาคารออมสิน
  GHB   // ธนาคารอาคารสงเคราะห์
  SAM   // บริษัทบริหารสินทรัพย์สุขุมวิท
}

enum AssetStatus {
  ACTIVE    // ยังขายอยู่
  SOLD      // ขายแล้ว
  CANCELLED // ยกเลิก
  EXPIRED   // หมดอายุ
}

enum ScrapeStatus {
  RUNNING   // กำลังทำงาน
  COMPLETED // เสร็จสิ้น
  FAILED    // ล้มเหลว
  PARTIAL   // เสร็จบางส่วน
}

enum IssueType {
  MISSING_DEED      // ไม่มีเลขที่โฉนด
  MISSING_LOCATION  // ไม่มีข้อมูลที่ตั้ง
  MISSING_PRICE     // ไม่มีราคา
  FETCH_FAILED      // ดึงข้อมูล detail ไม่ได้
  PARSE_ERROR       // parse ข้อมูลไม่ได้
  LANDDEED_FAILED   // ดึงข้อมูลโฉนดไม่ได้
  INCOMPLETE_DATA   // ข้อมูลไม่ครบ (ทั่วไป)
}

enum IssueStatus {
  PENDING   // รอแก้ไข
  RETRYING  // กำลัง retry
  RESOLVED  // แก้ไขแล้ว
  IGNORED   // ไม่สนใจ
}

/// ทรัพย์สินจากหลายแหล่ง
model Asset {
  id Int @id @default(autoincrement())

  // Multi-source support
  source        DataSource  @default(LED)           // แหล่งที่มา
  sourceAssetId String?     @db.VarChar(100)        // ID จากต้นทาง
  sourceUrl     String?     @db.VarChar(500)        // URL ต้นทาง

  // ข้อมูลหลัก
  auctionLot String  @db.VarChar(100)  // ล็อตประมูล เช่น "LOM 23/68"
  bidNumber  String  @db.VarChar(50)   // ลำดับที่ขาย เช่น "2 - 1"
  caseNumber String? @db.VarChar(100)  // เลขที่คดี (บาง source อาจไม่มี)
  deedNo     String? @db.VarChar(500)  // เลขที่โฉนด (อาจมีหลายเลขคั่นด้วย comma)

  // ประเภททรัพย์สิน
  assetType   String  @db.VarChar(100) // ที่ดินว่างเปล่า, ที่ดินพร้อมสิ่งปลูกสร้าง
  assetTypeId String? @db.VarChar(10)  // รหัสประเภท

  // ขนาด
  rai  Decimal @default(0) @db.Decimal(10, 2) // ไร่
  ngan Decimal @default(0) @db.Decimal(10, 2) // งาน
  sqWa Decimal @default(0) @db.Decimal(10, 2) // ตารางวา

  // ราคา
  appraisalPrice Decimal? @db.Decimal(15, 2) // ราคาประเมิน
  reserveFund    Decimal? @db.Decimal(15, 2) // เงินมัดจำ
  reserveFund1   Decimal? @db.Decimal(15, 2) // เงินมัดจำรอบถัดไป

  // ที่ตั้ง
  address  String? @db.VarChar(255)
  tambol   String? @db.VarChar(100) // ตำบล
  ampur    String? @db.VarChar(100) // อำเภอ
  province String? @db.VarChar(100) // จังหวัด

  // สถานะ
  status AssetStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)
  scrapedAt DateTime @default(now()) @db.DateTime(0) // วันที่ scrape ข้อมูล

  // Relations
  detail       AssetDetail?
  bidSchedules BidSchedule[]
  landDeedInfo LandDeedInfo?
  scrapeLog    ScrapeLog?    @relation(fields: [scrapeLogId], references: [id])
  scrapeLogId  Int?

  // Indexes สำหรับค้นหา
  @@index([source, auctionLot, bidNumber, deedNo, assetTypeId])
  @@index([source, sourceAssetId])
  @@index([source])
  @@index([province])
  @@index([ampur])
  @@index([assetType])
  @@index([appraisalPrice])
  @@index([caseNumber])
  @@index([deedNo])
  @@index([scrapedAt])
  @@index([scrapeLogId])
  @@map("Asset")
}

/// รายละเอียดทรัพย์สิน (1:1 กับ Asset)
model AssetDetail {
  id      Int   @id @default(autoincrement())
  assetId Int   @unique
  asset   Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // ข้อมูลคดี
  courtName   String? @db.VarChar(100) // ชื่อศาล
  courtId     String? @db.VarChar(10)  // รหัสศาล
  lawSuitNo   String? @db.VarChar(50)  // เลขที่คดี
  lawSuitYear String? @db.VarChar(10)  // ปีคดี

  // ข้อมูลโฉนด
  deedNo     String? @db.VarChar(500) // เลขที่โฉนด (อาจมีหลายเลขคั่นด้วย comma)
  deedTambol String? @db.VarChar(100)
  deedAmpur  String? @db.VarChar(100)
  deedCity   String? @db.VarChar(100)
  landType   String? @db.VarChar(100) // ประเภทโฉนด
  landDesc   String? @db.VarChar(255) // รายละเอียด

  // ข้อมูลบุคคล
  ownerName     String? @db.VarChar(255) // เจ้าของ
  ownerSuitName String? @db.VarChar(255) // ชื่อในคดี
  plaintiff     String? @db.VarChar(255) // โจทก์
  defendant     String? @db.VarChar(255) // จำเลย
  occupant      String? @db.VarChar(255) // ผู้ครอบครอง

  // สถานที่ขาย
  saleLocation1 String? @db.Text
  saleLocation2 String? @db.Text
  saleTime1     String? @db.VarChar(20)
  saleTime2     String? @db.VarChar(20)
  saleType      String? @db.VarChar(100) // ประเภทการขาย

  // ราคาแต่ละรอบ
  price1 Decimal? @db.Decimal(15, 2)
  price2 Decimal? @db.Decimal(15, 2)
  price3 Decimal? @db.Decimal(15, 2)
  price4 Decimal? @db.Decimal(15, 2)
  price5 Decimal? @db.Decimal(15, 2)
  price6 Decimal? @db.Decimal(15, 2)
  price7 Decimal? @db.Decimal(15, 2)
  price8 Decimal? @db.Decimal(15, 2)

  // ข้อมูลอื่นๆ
  tel     String? @db.VarChar(50)
  remark  String? @db.Text
  remark1 String? @db.Text
  eauc    String? @db.VarChar(10) // ประมูลออนไลน์

  // รูปภาพ (paths)
  landPicture String? @db.VarChar(500)
  map         String? @db.VarChar(500)
  mapJot      String? @db.VarChar(500)

  // Timestamps
  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)

  @@index([assetId])
  @@index([deedNo])
  @@index([ownerName])
  @@map("AssetDetail")
}

/// กำหนดการประมูล
model BidSchedule {
  id      Int   @id @default(autoincrement())
  assetId Int
  asset   Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  roundNumber Int      // รอบที่ 1-8
  bidDate     DateTime @db.DateTime(0) // วันประมูล
  price       Decimal? @db.Decimal(15, 2) // ราคารอบนั้น
  isSale      Boolean  @default(true) // เปิดขายหรือไม่

  createdAt DateTime @default(now()) @db.DateTime(0)

  @@unique([assetId, roundNumber])
  @@index([assetId])
  @@index([bidDate])
  @@map("BidSchedule")
}

/// ข้อมูลโฉนดจาก LandsMaps API
model LandDeedInfo {
  id      Int   @id @default(autoincrement())
  assetId Int   @unique
  asset   Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // ข้อมูลที่ตั้ง
  provName   String? @db.VarChar(100)
  amphurName String? @db.VarChar(100)
  tumbolName String? @db.VarChar(100)
  landOffice String? @db.VarChar(255)

  // ข้อมูลที่ดิน
  parcelType String? @db.VarChar(100) // ประเภทโฉนด
  parcelNo   String? @db.VarChar(50)  // เลขที่โฉนด (masked)
  landNo     String? @db.VarChar(50)  // เลขที่ดิน
  surveyNo   String? @db.VarChar(50)  // เลขที่รังวัด
  utm        String? @db.VarChar(100) // ระวาง

  // ขนาด
  rai  Int     @default(0)
  ngan Int     @default(0)
  wa   Decimal @default(0) @db.Decimal(10, 2)

  // ราคาประเมิน
  landPrice String? @db.VarChar(50) // ราคา บาท/ตร.ว.

  // พิกัด GPS
  latitude  Decimal? @db.Decimal(12, 8)
  longitude Decimal? @db.Decimal(12, 8)
  utmZone   String?  @db.VarChar(10)
  utmN      Decimal? @db.Decimal(20, 6)
  utmE      Decimal? @db.Decimal(20, 6)

  // รหัสพื้นที่
  provId       String? @db.VarChar(10)
  amphurId     String? @db.VarChar(10)
  tambolId     String? @db.VarChar(10)
  landOfficeId String? @db.VarChar(20)

  // ลิงก์
  qrcodeLink      String? @db.VarChar(500)
  surveyPriceLink String? @db.VarChar(500)

  // ติดต่อ
  orgTel String? @db.VarChar(50)

  // Raw data
  rawJson Json? // เก็บ JSON ดิบ

  // Timestamps
  createdAt DateTime @default(now()) @db.DateTime(0)
  updatedAt DateTime @updatedAt @db.DateTime(0)
  fetchedAt DateTime @default(now()) @db.DateTime(0) // วันที่ดึงข้อมูล

  @@index([assetId])
  @@index([provName])
  @@index([amphurName])
  @@index([parcelNo])
  @@map("LandDeedInfo")
}

/// Log การ Scrape
model ScrapeLog {
  id Int @id @default(autoincrement())

  // Source
  source DataSource @default(LED)

  // ข้อมูล Session
  searchProvince String? @db.VarChar(100)
  searchParams   Json?   // เก็บ search parameters
  startPage      Int     @default(1)
  endPage        Int?
  totalResults   Int     @default(0)
  totalPages     Int     @default(0)

  // สถิติ
  itemsScraped Int @default(0)
  itemsNew     Int @default(0)
  itemsUpdated Int @default(0)
  itemsFailed  Int @default(0)

  // สถานะ
  status       ScrapeStatus @default(RUNNING)
  errorMessage String?      @db.Text

  // Timestamps
  startedAt   DateTime  @default(now()) @db.DateTime(0)
  completedAt DateTime? @db.DateTime(0)

  // Relations
  assets Asset[]
  issues ScrapeIssue[]

  @@index([source])
  @@index([startedAt])
  @@map("ScrapeLog")
}

/// Log ปัญหาการ scrape ข้อมูลไม่ครบ
model ScrapeIssue {
  id Int @id @default(autoincrement())

  source      DataSource
  scrapeLogId Int?
  scrapeLog   ScrapeLog? @relation(fields: [scrapeLogId], references: [id])

  // ข้อมูลระบุตัวตน
  pageNumber Int?
  itemIndex  Int?
  auctionLot String? @db.VarChar(100)
  bidNumber  String? @db.VarChar(50)
  sourceUrl  String? @db.VarChar(500)
  assetId    Int?    // ถ้าบันทึก asset สำเร็จแต่ข้อมูลไม่ครบ

  // ปัญหาที่พบ
  issueType     IssueType         // ประเภทปัญหา
  missingFields String? @db.Text  // JSON array ของ fields ที่หาย
  errorMessage  String? @db.Text  // ข้อความ error
  rawData       Json?             // เก็บ raw data สำหรับ debug

  // สถานะ
  status     IssueStatus @default(PENDING)
  retryCount Int         @default(0)

  createdAt  DateTime  @default(now()) @db.DateTime(0)
  updatedAt  DateTime  @updatedAt @db.DateTime(0)
  resolvedAt DateTime? @db.DateTime(0)

  @@index([source, status])
  @@index([scrapeLogId])
  @@index([issueType])
  @@index([createdAt])
  @@map("ScrapeIssue")
}